<?php

declare(strict_types=1);

function faq_chatbot_pairs(): array
{
    // 10–20 ชุดคำถาม/คำตอบ (ปรับ/เพิ่มได้ตามต้องการ)
    return [
        [
            'q' => 'ระบบนี้คืออะไร',
            'a' => 'ระบบนี้คือแพลตฟอร์ม EquityLearnKU สำหรับจัดการการเรียนรู้/สื่อการสอน/เวิร์กชอป และมีพื้นที่ให้คำปรึกษา (Consulting) สำหรับผู้ใช้งาน',
            'keywords' => ['ระบบ', 'คืออะไร', 'ทำอะไรได้', 'equitylearnku'],
        ],

        // ===== กลุ่มคำถาม: ความเสมอภาคทางการศึกษา (เพิ่มแบบกว้าง ๆ) =====
        [
            'q' => 'ความเสมอภาคทางการศึกษาคืออะไร ต่างจากความเท่าเทียมอย่างไร',
            'a' => "ความเท่าเทียม (Equality) คือให้เหมือนกันทุกคน เช่น แจกหนังสือแบบเดียวกันจำนวนเท่ากัน\n" .
                  "ความเสมอภาค (Equity) คือให้ตามความจำเป็นเพื่อให้ไปถึงเป้าหมายได้ใกล้เคียงกัน เช่น คนที่อ่านช้ากว่าได้เวลาเพิ่ม คนที่ขาดอุปกรณ์ได้ทางเลือกแบบออฟไลน์\n\n" .
                  "สรุปง่าย ๆ: เท่าเทียม = ให้เท่ากัน, เสมอภาค = ทำให้เข้าถึงและสำเร็จได้จริงแม้พื้นฐานต่างกัน",
            'keywords' => ['ความเสมอภาค', 'equity', 'ความเท่าเทียม', 'equality', 'ต่างกัน'],
        ],
        [
            'q' => 'ทำอย่างไรให้เกิดความเสมอภาคในชั้นเรียน',
            'a' => "แนวทางกว้าง ๆ ที่ทำได้จริงในห้องเรียน:\n" .
                  "1) ตั้งกติกาห้องเรียนที่ปลอดภัยและเคารพกัน (ไม่ล้อเลียน/ไม่เหยียด)\n" .
                  "2) ออกแบบกิจกรรมหลายรูปแบบให้เลือก (พูด/เขียน/ทำงานกลุ่ม/ทำเดี่ยว) เพื่อรองรับความถนัดต่างกัน\n" .
                  "3) ให้ตัวอย่าง/โครงช่วย (template, checklist) สำหรับคนที่เริ่มต้นยาก\n" .
                  "4) ตรวจเช็คความเข้าใจระหว่างทาง (ถามสั้น ๆ, exit ticket) เพื่อช่วยคนที่กำลังหลุด\n" .
                  "5) เปิดช่องทางถามแบบไม่อาย เช่น กล่องคำถาม/ส่งข้อความส่วนตัว\n\n" .
                  "หัวใจคือทำให้ทุกคน ‘เข้าถึงบทเรียน’ และ ‘กล้าลองผิดลองถูก’ ได้",
            'keywords' => ['ชั้นเรียน', 'ห้องเรียน', 'inclusive', 'เสมอภาค', 'บรรยากาศ'],
        ],
        [
            'q' => 'ครูควรปรับการสอนอย่างไรให้ผู้เรียนพื้นฐานต่างกันตามทัน',
            'a' => "ลองใช้หลักคิด 3 ส่วน:\n" .
                  "- ปรับเนื้อหา (Content): มีสรุปสั้น/วิดีโอ/บทความอ่านง่าย และเวอร์ชันละเอียด\n" .
                  "- ปรับกระบวนการ (Process): แบ่งงานเป็นขั้นตอน, ทำตัวอย่างร่วมกัน 1 รอบก่อนปล่อยทำเอง\n" .
                  "- ปรับผลลัพธ์ (Product): ให้ส่งงานได้หลายแบบ เช่น รายงาน/สไลด์/คลิปสั้น/แผนผังความคิด\n\n" .
                  "เสริมด้วยการจัดกลุ่มแบบยืดหยุ่น (flexible grouping) และการช่วยรายบุคคลช่วงสั้น ๆ จะลดช่องว่างได้เร็ว",
            'keywords' => ['ปรับการสอน', 'พื้นฐานต่างกัน', 'ตามไม่ทัน', 'UDL', 'differentiation'],
        ],
        [
            'q' => 'ประเมินผลอย่างเป็นธรรมและเสมอภาคควรทำอย่างไร',
            'a' => "แนวทางประเมินแบบเป็นธรรม (Fair assessment) ที่พบบ่อย:\n" .
                  "1) ใช้เกณฑ์ชัดเจน (rubric) และบอกล่วงหน้า\n" .
                  "2) มีการประเมินหลายครั้ง/หลายรูปแบบ ไม่ยึดครั้งเดียวตัดสินทั้งหมด\n" .
                  "3) อนุญาตการแก้ไขงาน (revision) เพื่อให้การประเมินเป็นการเรียนรู้ ไม่ใช่ลงโทษ\n" .
                  "4) แยกคะแนน ‘ความพยายาม/กระบวนการ’ กับ ‘ความถูกต้อง’ ให้เหมาะกับเป้าหมายรายวิชา\n" .
                  "5) ระวังอคติ เช่น ภาษา/สำเนียง/บุคลิก ไม่ควรมีผลต่อคะแนนถ้าไม่ใช่เป้าหมายการเรียนรู้\n\n" .
                  "สรุปคือให้คะแนนตามเป้าหมายการเรียนรู้จริง ๆ และให้โอกาสพัฒนา",
            'keywords' => ['ประเมินผล', 'คะแนน', 'rubric', 'เป็นธรรม', 'เสมอภาค'],
        ],
        [
            'q' => 'สื่อการเรียนการสอนแบบไหนช่วยลดความเหลื่อมล้ำ',
            'a' => "สื่อที่ช่วยลดช่องว่างมักมีคุณสมบัติเหล่านี้:\n" .
                  "- เข้าถึงง่าย: ไฟล์ขนาดไม่ใหญ่ มีเวอร์ชันออฟไลน์/พิมพ์ได้\n" .
                  "- รองรับความหลากหลาย: มีคำบรรยาย (caption), มีรูป/ตัวอย่างประกอบ, ใช้ภาษาที่ชัดเจน\n" .
                  "- เป็นชิ้นเล็ก ๆ: แบ่งบทเรียนเป็นตอนสั้น ๆ (microlearning) เพื่อให้ตามทันทีละขั้น\n" .
                  "- มีแบบฝึกพร้อมเฉลย/คำอธิบาย: ช่วยให้เรียนรู้ด้วยตนเองได้\n\n" .
                  "ถ้าต้องเลือก ‘อย่างเดียว’ ให้เริ่มจากสรุป 1 หน้า + แบบฝึก 5 ข้อ + เฉลยอธิบาย จะคุ้มค่าที่สุด",
            'keywords' => ['สื่อการสอน', 'สื่อการเรียนการสอน', 'media', 'ความเหลื่อมล้ำ', 'เข้าถึง'],
        ],
        [
            'q' => 'ถ้านักเรียนไม่มีอุปกรณ์หรืออินเทอร์เน็ต ควรทำอย่างไร',
            'a' => "แนวทางที่ทำได้โดยไม่ทำให้ผู้เรียนเสียโอกาส:\n" .
                  "1) เตรียมทางเลือกออฟไลน์: ใบงาน/เอกสารพิมพ์/ไฟล์ที่เปิดได้ในมือถือโดยไม่ต้องเน็ต\n" .
                  "2) ลดการพึ่งพาวิดีโอความละเอียดสูง: ใช้สไลด์+เสียง/คลิปสั้น/ภาพนิ่งแทน\n" .
                  "3) ยืดหยุ่นเวลาและช่องทางส่งงาน: ส่งเป็นรูปถ่าย/ส่งทีหลัง/ส่งผ่านช่องทางที่เข้าถึงได้\n" .
                  "4) ใช้การเรียนแบบคู่/กลุ่ม: ให้แชร์อุปกรณ์อย่างเหมาะสม (โดยไม่กดดันคนที่ไม่มี)\n" .
                  "5) ประสานทรัพยากร: ขอเครื่องยืม/มุมเรียนรู้/จุด Wi‑Fi ของหน่วยงาน\n\n" .
                  "หลักคือ ‘ไม่ให้เครื่องมือเป็นเงื่อนไขตัดสิทธิ์การเรียนรู้’",
            'keywords' => ['ไม่มีอินเทอร์เน็ต', 'ไม่มีอุปกรณ์', 'มือถือ', 'ออนไลน์', 'ออฟไลน์'],
        ],
        [
            'q' => 'ทำอย่างไรให้ผู้เรียนทุกคนมีส่วนร่วม ไม่ถูกทิ้งไว้ข้างหลัง',
            'a' => "วิธีทำให้ ‘ทุกคนมีส่วนร่วม’ แบบง่าย ๆ:\n" .
                  "- ใช้คำถามสั้น ๆ ให้ตอบได้หลายระดับ (ง่าย→ยาก) เพื่อให้ทุกคนเริ่มได้\n" .
                  "- ให้เวลาคิด (wait time) และเปิดโอกาสตอบผ่านการเขียนก่อนพูด\n" .
                  "- ใช้กิจกรรม pair-share: คุยเป็นคู่ก่อน แล้วค่อยแชร์หน้าห้อง ลดความกังวล\n" .
                  "- ติดตามรายคน: สังเกตคนเงียบ/คนหลุด แล้วช่วยด้วยคำถามนำทาง\n\n" .
                  "เป้าหมายคือทำให้การมีส่วนร่วม ‘ปลอดภัย’ และ ‘มีทางเลือก’ ไม่บังคับให้ทุกคนต้องเก่งเท่ากัน",
            'keywords' => ['มีส่วนร่วม', 'ไม่ถูกทิ้ง', 'participation', 'pair share', 'ชั้นเรียน'],
        ],
        [
            'q' => 'ทำอย่างไรให้ชั้นเรียนปลอดภัยและเคารพความแตกต่าง',
            'a' => "ชั้นเรียนที่ปลอดภัย (safe learning environment) คือพื้นฐานของความเสมอภาค:\n" .
                  "1) ตั้งกติกาที่ชัดเจนเรื่องการสื่อสาร (ไม่ดูถูก ไม่เหยียด ไม่เผยข้อมูลส่วนตัว)\n" .
                  "2) ใช้ภาษาที่เคารพและเป็นกลางทางเพศ/ฐานะ/ภูมิหลัง\n" .
                  "3) จัดการการล้อเลียนหรือการกลั่นแกล้งทันที (ไม่ปล่อยผ่าน)\n" .
                  "4) ให้ผู้เรียนรู้สึกว่า ‘ผิดได้’ โดยเน้นการลองและการสะท้อนคิด มากกว่าการจับผิด\n\n" .
                  "เมื่อผู้เรียนรู้สึกปลอดภัย เขาจะกล้าถาม กล้าลอง และเรียนรู้ได้เต็มศักยภาพมากขึ้น",
            'keywords' => ['ปลอดภัย', 'เคารพ', 'ความแตกต่าง', 'bully', 'บรรยากาศ'],
        ],
        [
            'q' => 'จะทำให้เกิดความเสมอภาคทางการศึกษาในระดับโรงเรียนหรือระบบได้อย่างไร',
            'a' => "ภาพรวมระดับโรงเรียน/ระบบ มักทำได้หลายด้านร่วมกัน:\n" .
                  "- จัดสรรทรัพยากรตามความจำเป็น (เช่น ห้องเรียน/อุปกรณ์/ทุน) ไม่ใช่เฉลี่ยเท่ากันเสมอ\n" .
                  "- สนับสนุนครู: อบรมการสอนแบบหลากหลาย (UDL/การสอนแบบแตกต่าง) และชุมชนครูแลกเปลี่ยน\n" .
                  "- มีระบบดูแลช่วยเหลือผู้เรียน: แนะแนว, ที่ปรึกษา, การติดตามความเสี่ยงหลุดจากระบบ\n" .
                  "- ใช้ข้อมูลอย่างรับผิดชอบ: ดูช่องว่างผลลัพธ์และแก้ที่สาเหตุ ไม่ใช้ข้อมูลไปตีตรา\n\n" .
                  "ความเสมอภาคที่ยั่งยืนต้องเป็น ‘ระบบ’ ไม่ใช่ภาระของครูหรือผู้เรียนคนใดคนหนึ่ง",
            'keywords' => ['โรงเรียน', 'นโยบาย', 'จัดสรร', 'ทรัพยากร', 'ระบบ', 'ความเสมอภาค'],
        ],
        [
            'q' => 'เข้าสู่ระบบไม่ได้ต้องทำอย่างไร',
            'a' => 'ลองตรวจสอบ 1) username/รหัสนิสิตถูกต้อง 2) รหัสผ่านถูกต้อง 3) อินเทอร์เน็ต/เซิร์ฟเวอร์ใช้งานได้ หากยังไม่ได้ ให้ลองรีเซ็ตรหัสผ่านหรือแจ้งผู้ดูแลระบบเพื่อช่วยตรวจสอบบัญชี',
            'keywords' => ['เข้าสู่ระบบ', 'ล็อกอิน', 'login', 'ไม่ได้', 'error'],
        ],
        [
            'q' => 'ลืมรหัสผ่านทำอย่างไร',
            'a' => 'หากมีเมนูเปลี่ยน/รีเซ็ตรหัสผ่านให้ใช้งานได้ทันที หรือแจ้งผู้ดูแลระบบเพื่อรีเซ็ตรหัสผ่านให้ แล้วตั้งรหัสผ่านใหม่อีกครั้ง',
            'keywords' => ['ลืมรหัสผ่าน', 'reset', 'เปลี่ยนรหัสผ่าน'],
        ],
        [
            'q' => 'นิสิตใช้รหัสอะไรในการเข้าระบบ',
            'a' => 'นิสิตใช้ “รหัสนิสิต” เป็น username สำหรับเข้าระบบ (ไม่จำเป็นต้องเป็นอีเมล) และใช้รหัสผ่านที่ตั้งไว้',
            'keywords' => ['นิสิต', 'รหัสนิสิต', 'username', 'อีเมล'],
        ],
        [
            'q' => 'เพิ่มผู้ใช้งานใหม่ต้องทำอย่างไร',
            'a' => 'ไปที่เมนูผู้ใช้งาน (Users) แล้วกด “+ เพิ่มผู้ใช้งาน” เลือกประเภทผู้ใช้งาน กรอกข้อมูลที่จำเป็น แล้วกดบันทึก ระบบจะเพิ่มผู้ใช้งานและรีเฟรชรายการอัตโนมัติ',
            'keywords' => ['เพิ่มผู้ใช้งาน', 'สร้างผู้ใช้', 'users', 'admin'],
        ],
        [
            'q' => 'เวิร์กชอปคืออะไร',
            'a' => 'เวิร์กชอปเป็นชุดกิจกรรม/แบบประเมินที่มีคำถามหลายรูปแบบ (ตัวเลือก/อธิบาย) สามารถกำหนดคะแนนรวม 100 และตั้งเวลาเปิด-ปิดได้',
            'keywords' => ['เวิร์กชอป', 'workshop', 'คะแนน', 'คำถาม'],
        ],
        [
            'q' => 'ทำไมบันทึกเวิร์กชอปไม่ได้',
            'a' => 'สาเหตุที่พบบ่อย: 1) คะแนนรวมไม่เท่ากับ 100 2) คำถามแบบตัวเลือกยังไม่ได้กำหนดคำตอบ 3) ยังกรอกข้อมูลไม่ครบ ลองตรวจสอบเงื่อนไขเหล่านี้แล้วบันทึกใหม่',
            'keywords' => ['บันทึก', 'เวิร์กชอป', 'ไม่ได้', 'คะแนนรวม', '100'],
        ],
        [
            'q' => 'เพิ่มคำถามในเวิร์กชอปได้สูงสุดกี่ข้อ',
            'a' => 'โดยปกติระบบจำกัดจำนวนคำถามไว้ไม่เกิน 10 ข้อต่อเวิร์กชอป (เพื่อความเหมาะสมในการประเมินและใช้งาน)',
            'keywords' => ['เพิ่มคำถาม', 'สูงสุด', 'กี่ข้อ', '10'],
        ],
        [
            'q' => 'อัปโหลดสื่อการสอนทำอย่างไร',
            'a' => 'เข้าเมนูสื่อการสอน (Media/Storage) เลือกไฟล์ที่ต้องการ แล้วกดอัปโหลด หากไฟล์ใหญ่/ช้าให้ลองเปลี่ยนเครือข่ายหรือบีบอัดไฟล์ก่อน',
            'keywords' => ['อัปโหลด', 'สื่อ', 'media', 'storage', 'ไฟล์'],
        ],
        [
            'q' => 'ระบบรองรับไฟล์ประเภทไหนบ้าง',
            'a' => 'โดยทั่วไปจะรองรับไฟล์เอกสาร/รูปภาพ/วิดีโอที่ใช้งานทั่วไป แต่ข้อจำกัดขึ้นกับการตั้งค่าเซิร์ฟเวอร์ หากอัปโหลดไม่ผ่านให้แจ้งผู้ดูแลระบบพร้อมชนิดไฟล์และขนาดไฟล์',
            'keywords' => ['รองรับไฟล์', 'ประเภทไฟล์', 'upload', 'ขนาดไฟล์'],
        ],
        [
            'q' => 'ติดต่อผู้ดูแลระบบได้อย่างไร',
            'a' => 'สามารถติดต่อผู้ดูแลระบบผ่านช่องทางที่หน่วยงานกำหนด (เช่น อีเมล/ไลน์กลุ่ม) หากต้องการให้แสดงข้อมูลติดต่อที่แน่นอน แจ้งอีเมล/ช่องทางที่ต้องการให้ใส่ในหน้า FAQ ได้เลย',
            'keywords' => ['ติดต่อ', 'ผู้ดูแลระบบ', 'admin', 'support'],
        ],
        [
            'q' => 'ใช้งานบนมือถือได้ไหม',
            'a' => 'ได้ ระบบรองรับการใช้งานบนมือถือและแท็บเล็ต แนะนำใช้เบราว์เซอร์รุ่นใหม่เพื่อประสบการณ์ที่ดีที่สุด',
            'keywords' => ['มือถือ', 'แท็บเล็ต', 'responsive'],
        ],
        [
            'q' => 'ข้อมูลปีการศึกษาและภาคการศึกษาใช้ทำอะไร',
            'a' => 'ใช้ประกอบข้อมูลโปรไฟล์นิสิตและช่วยจัดกลุ่ม/ออกรายงานตามปีการศึกษาและภาคการศึกษาได้สะดวกขึ้น',
            'keywords' => ['ปีการศึกษา', 'ภาคการศึกษา', 'academic'],
        ],
        [
            'q' => 'ทำไมระบบตอบไม่ตรงคำถาม',
            'a' => 'ระบบนี้ตอบโดยการจับคู่คำถามกับชุด FAQ ที่มีอยู่ หากคำถามของคุณไม่ใกล้เคียงกับชุดคำถาม ระบบอาจตอบไม่ตรง ลองถามให้ใกล้กับหัวข้อ เช่น “เข้าสู่ระบบไม่ได้”, “ลืมรหัสผ่าน”, “บันทึกเวิร์กชอปไม่ได้”',
            'keywords' => ['ตอบไม่ตรง', 'ไม่เข้าใจ', 'ทำไม'],
        ],
    ];
}

function faq_chatbot_reply(string $userMessage): string
{
    $userMessage = trim($userMessage);
    if ($userMessage === '') {
        return 'พิมพ์คำถามได้เลยครับ/ค่ะ';
    }

    $pairs = faq_chatbot_pairs();
    $best = faq_chatbot_best_match($userMessage, $pairs);

    if ($best === null) {
        $suggestions = array_slice(array_map(fn ($p) => $p['q'], $pairs), 0, 6);
        return "ขออภัย ยังไม่พบคำตอบที่ตรงกับคำถามนี้\nลองถามในหัวข้อใกล้เคียง เช่น: " . implode(' / ', $suggestions);
    }

    return $best['a'];
}

function faq_chatbot_best_match(string $input, array $pairs): ?array
{
    $inputNorm = faq_chatbot_normalize($input);
    if ($inputNorm === '') {
        return null;
    }

    $bestPair = null;
    $bestScore = 0.0;

    foreach ($pairs as $pair) {
        $question = (string)($pair['q'] ?? '');
        $answer = (string)($pair['a'] ?? '');
        if ($question === '' || $answer === '') {
            continue;
        }

        $qNorm = faq_chatbot_normalize($question);
        if ($qNorm === '') {
            continue;
        }

        $score = faq_chatbot_similarity_score($inputNorm, $qNorm, (array)($pair['keywords'] ?? []));
        if ($score > $bestScore) {
            $bestScore = $score;
            $bestPair = $pair;
        }
    }

    // threshold ปรับได้ตามต้องการ: ยิ่งสูงยิ่งเข้ม
    if ($bestPair === null || $bestScore < 0.18) {
        return null;
    }

    return $bestPair;
}

function faq_chatbot_similarity_score(string $inputNorm, string $qNorm, array $keywords): float
{
    // 1) n-gram Jaccard (เหมาะกับภาษาไทยมากกว่า token แบบเว้นวรรค)
    $ngram = faq_chatbot_jaccard_ngrams($inputNorm, $qNorm, 2);

    // 2) substring boost (คำถามสั้น ๆ มักเจอแบบนี้)
    $substrBoost = 0.0;
    if ($qNorm !== '' && mb_strpos($inputNorm, $qNorm, 0, 'UTF-8') !== false) {
        $substrBoost = 0.25;
    } elseif ($inputNorm !== '' && mb_strpos($qNorm, $inputNorm, 0, 'UTF-8') !== false) {
        $substrBoost = 0.15;
    }

    // 3) keyword bonus
    $kwBoost = 0.0;
    foreach ($keywords as $kw) {
        $kwN = faq_chatbot_normalize((string)$kw);
        if ($kwN !== '' && mb_strpos($inputNorm, $kwN, 0, 'UTF-8') !== false) {
            $kwBoost += 0.04;
        }
    }
    $kwBoost = min(0.20, $kwBoost);

    return min(1.0, ($ngram * 0.80) + $substrBoost + $kwBoost);
}

function faq_chatbot_jaccard_ngrams(string $a, string $b, int $n = 2): float
{
    $aSet = faq_chatbot_ngrams($a, $n);
    $bSet = faq_chatbot_ngrams($b, $n);

    if (!$aSet || !$bSet) {
        return 0.0;
    }

    $aKeys = array_fill_keys($aSet, true);
    $bKeys = array_fill_keys($bSet, true);

    $intersection = 0;
    foreach ($aKeys as $k => $_) {
        if (isset($bKeys[$k])) {
            $intersection++;
        }
    }

    $union = count($aKeys) + count($bKeys) - $intersection;
    if ($union <= 0) {
        return 0.0;
    }

    return $intersection / $union;
}

function faq_chatbot_ngrams(string $text, int $n = 2): array
{
    $text = trim($text);
    if ($text === '') {
        return [];
    }

    $len = mb_strlen($text, 'UTF-8');
    if ($len <= $n) {
        return [$text];
    }

    $grams = [];
    for ($i = 0; $i <= $len - $n; $i++) {
        $grams[] = mb_substr($text, $i, $n, 'UTF-8');
    }

    return $grams;
}

function faq_chatbot_normalize(string $text): string
{
    $text = mb_strtolower($text, 'UTF-8');
    $text = trim($text);

    // ลบสัญลักษณ์/วรรคตอนทั่วไป (คงตัวอักษรไทย/อังกฤษ/ตัวเลข)
    $text = preg_replace('/[^\p{Thai}a-z0-9\s]+/u', ' ', $text);
    $text = preg_replace('/\s+/u', ' ', $text);

    return trim($text);
}
